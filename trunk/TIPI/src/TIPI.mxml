<?xml version="1.0" encoding="utf-8"?>
<s:Application xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   xmlns:s="library://ns.adobe.com/flex/spark" 
			   xmlns:mx="library://ns.adobe.com/flex/mx"
			   initialize="initializeHandler(event)"
			   minWidth="500" minHeight="300">
	<fx:Style source="tipi.css"/>
	
	<fx:Script>
		<![CDATA[
			import flash.net.navigateToURL;
			
			import mx.controls.Alert;
			import mx.validators.Validator;
			private var tipiUrlBase:String = "http://www.jepaiemesserviceslocaux.dgfip.finances.gouv.fr/tpa/paiement.web?";
			private var tipiUrlComplete:String;
			private var validateurs:Array;
			
			private function initializeHandler(event:Event):void{
				// crée un tableau avec tous les validators
				validateurs = [numClientValidateur, exerciceValidateur, refDetteValidateur, objetValidateur, montantValidateur, emailValidateur];
			}
			
			protected function btnEnvoyer_clickHandler(event:MouseEvent):void
			{
				// déclenche tous les validateurs
				var results:Array = Validator.validateAll(validateurs);
				
				// si le tableau est vide, tout s'est bien passé
				// sinon, au moins un des validateurs n'est pas passé
				if (results.length > 0){
					var message:String = "Les champs suivants sont incorrects:\n";
					
					//boucle sur les résultats et retrouve l'id correspondant
					for (var i:uint = 0;i<results.length;i++){
						message  += results[i].target.source.id + "\n";
					}
					Alert.show(message);
				}
				else
				{		
					tipiUrlComplete = tipiUrlBase + "numcli=" + numClient.text;
					tipiUrlComplete += "&exer=" + exercice.text;
					tipiUrlComplete += "&refdet=" + refDette.text;
					tipiUrlComplete += "&objet=" + objet.text;
					tipiUrlComplete += "&montant=" + montant.text;
					tipiUrlComplete += "&urlcl=www.agglo-sophia-antipolis.fr";
					tipiUrlComplete += "&mel=" + email.text;
					tipiUrlComplete += "&saisie=T";
					navigateToURL( new URLRequest(tipiUrlComplete) );	
				}
			}
			
		]]>
	</fx:Script>
	
	<fx:Declarations>
		<!-- Placer ici les éléments non visuels (services et objets de valeur, par exemple). -->
		<mx:StringValidator id="numClientValidateur" source="{numClient}" property="text" minLength="6" maxLength="6" tooShortError="Le numéro est trop court" tooLongError="Le numéro est trop long" />
		<mx:StringValidator id="exerciceValidateur" source="{exercice}" property="text" minLength="4" maxLength="4" tooShortError="L'exercice est trop court" tooLongError="L'exercice est trop long" />
		<mx:StringValidator id="refDetteValidateur" source="{refDette}" property="text" minLength="18" maxLength="18" tooShortError="La référence de la dette est trop courte" tooLongError="La référence de la dette est trop longue" />
		<mx:StringValidator id="objetValidateur" source="{objet}" property="text" maxLength="100" tooLongError="L'objet est trop long" />
		<mx:NumberValidator id="montantValidateur" source="{montant}" property="text" allowNegative="false" domain="int"/>
		<mx:EmailValidator id="emailValidateur" source="{email}" property="text"/>
	</fx:Declarations>
	<s:Form width="100%" height="100%">
		<s:FormItem label="Numéro client">
			<s:TextInput id="numClient" width="167"
						 text = "123456"
						 toolTip="Saisissez votre numéro de client attribué à la collectivité (longueur de 6 caractères)"
						 prompt="Saisissez votre numéro de client (longueur de 6 caractères)"/>
		</s:FormItem>
		<s:FormItem label="Exercice">
			<s:TextInput id="exercice" width="167"
						 text = "1234"
						 toolTip="Saisissez le numéro d'exercice (longueur de 4 caractères)"
						 prompt="Saisissez le numéro d'exercice (longueur de 4 caractères)"/>
		</s:FormItem>
		<s:FormItem label="Référence de la dette">
			<s:TextInput id="refDette" width="167"
						 text = "123456789012345678"
						 toolTip="Saisissez la référence de la dette (longueur de 18 caractères)"
						 prompt="Saisissez la référence de la dette (longueur de 18 caractères)"/>
		</s:FormItem>
		<s:FormItem label="Objet">
			<s:TextInput id="objet" width="100%"
						 text = "objet essai"
						 toolTip="Saisissez l'objet (longueur 100 caractères maximum)"
						 prompt="Saisissez l'objet (proscrire toutes données à caractère personnel)"/>
		</s:FormItem>
		<s:FormItem label="Montant">
			<s:TextInput id="montant" width="167"
						 text = "15200"
						 toolTip="Saisissez le montant (longueur de 6 chiffres maximum, sans point ni virgule)"
						 prompt="Saisissez le montant (sans point ni virgule)"/>
		</s:FormItem>
		<s:FormItem label="Mél">
			<s:TextInput id="email" width="167"
						 text = "b.lane"
						 toolTip="Saisissez votre mél"
						 prompt="Saisissez votre mél"/>
		</s:FormItem>

		<s:Button id="btnEnvoyer" label="Envoyer" click="btnEnvoyer_clickHandler(event)" />
	</s:Form>
</s:Application>
