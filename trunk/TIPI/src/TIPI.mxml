<?xml version="1.0" encoding="utf-8"?>
<s:Application xmlns:fx="http://ns.adobe.com/mxml/2009" 
			   xmlns:s="library://ns.adobe.com/flex/spark" 
			   xmlns:mx="library://ns.adobe.com/flex/mx"
			   initialize="initializeHandler(event)"
			   minWidth="500" minHeight="300">
	<fx:Style source="tipi.css"/>
	
	<fx:Script>
		<![CDATA[
			import flash.net.navigateToURL;
			
			import mx.controls.Alert;
			import mx.validators.Validator;
			private var tipiUrlBase:String = "http://www.jepaiemesserviceslocaux.dgfip.finances.gouv.fr/tpa/paiement.web?";
			private var tipiUrlComplete:String;
			private var refDette:String;
			private var validateurs:Array;
			
			private function initializeHandler(event:Event):void{
				// crée un tableau avec tous les validators
				validateurs = [exerciceValidateur, refTitreValidateur, objetValidateur, montantValidateur];
			}
			private function zeroPad( str:String, length:int ):String
			{
				if (str.length < length)
					return "0" + zeroPad(str, length-1);
				return str;
			}
			protected function btnEnvoyer_clickHandler(event:MouseEvent):void
			{
				// déclenche tous les validateurs
				var results:Array = Validator.validateAll(validateurs);
				var paddedTitre:String;
				
				// si le tableau est vide, tout s'est bien passé
				// sinon, au moins un des validateurs n'est pas passé
				if (results.length > 0){
					var message:String = "Les champs suivants sont incorrects:\n";
					
					//boucle sur les résultats et retrouve l'id correspondant
					for (var i:uint = 0;i<results.length;i++){
						message  += results[i].target.source.id + "\n";
					}
					Alert.show(message);
				}
				else
				{	
					paddedTitre = zeroPad( titre.text, 8 );
					refDette = exercice.text + paddedTitre + "000001";
					tipiUrlComplete = tipiUrlBase + "numcli=000257";
					tipiUrlComplete += "&exer=" + exercice.text;
					tipiUrlComplete += "&refdet=" + refDette;
					tipiUrlComplete += "&objet=" + objet.text;
					tipiUrlComplete += "&montant=" + montant.text;
					//tipiUrlComplete += "&urlcl=92.103.200.244%2Ftipi";
					tipiUrlComplete += "&mel=tipi%40agglo-casa.fr";
					tipiUrlComplete += "&saisie=T";
					navigateToURL( new URLRequest(tipiUrlComplete) );	
					btnEnvoyer.enabled = false;
				}
			}
			
		]]>
	</fx:Script>
	
	<fx:Declarations>
		<!-- Placer ici les éléments non visuels (services et objets de valeur, par exemple). -->
		<mx:StringValidator id="exerciceValidateur" source="{exercice}" property="text" minLength="4" maxLength="4" 
							tooShortError="L'exercice est trop court" 
							tooLongError="L'exercice est trop long" 
							requiredFieldError="Champ obligatoire" />
		<!--<mx:StringValidator id="refDetteValidateur" source="{refDette}" property="text" minLength="18" maxLength="18" 
							tooShortError="La référence de la dette est trop courte" 
							tooLongError="La référence de la dette est trop longue" 
							requiredFieldError="Champ obligatoire" />-->
		<mx:StringValidator id="refTitreValidateur" source="{titre}" property="text" minLength="1" maxLength="8"
							tooShortError="Le numéro de titre est trop court" 
							tooLongError="Le numéro de titre est trop long"
							requiredFieldError="Champ obligatoire" />
		<mx:StringValidator id="objetValidateur" source="{objet}" property="text" maxLength="100" 
							tooLongError="L'objet est trop long" 
							requiredFieldError="Champ obligatoire" />
		<mx:NumberValidator id="montantValidateur" source="{montant}" property="text" allowNegative="false" domain="int" 
							invalidCharError="Caractère(s) invalide(s)"
							invalidFormatCharsError="Caractère(s) de format invalide(s)"
							integerError="Doit être un entier"
							
							requiredFieldError="Champ obligatoire"/>
		<!--<mx:EmailValidator id="emailValidateur" source="{email}" property="text" 
						   invalidCharError="Caractère non valide"
						   invalidIPDomainError="Domaine IP non valide, ajouter des crochets"
						   invalidPeriodsInDomainError="Points invalides dans le nom de domaine"
						   missingAtSignError="Manque '@'"
						   missingPeriodInDomainError="Manque un point dans le nom de domaine"
						   missingUsernameError="Manque l'utilisateur"
						   requiredFieldError="Champ obligatoire"
						   invalidDomainError="Domaine invalide"/>--> 
	</fx:Declarations>
	<s:Form width="100%" height="100%">
		<s:FormItem width="310" label="Exercice">
			<s:TextInput id="exercice" width="167"
						 prompt="Saisissez le numéro d'exercice (longueur de 4 caractères)"
						 toolTip="Saisissez le numéro d'exercice (longueur de 4 caractères)"/>
		</s:FormItem>
		<s:FormItem width="311" label="Titre">
			<s:TextInput id="titre" width="167"
						 prompt="Saisissez le numéro de titre (longueur de 1 à 8 caractères)"
						 toolTip="Saisissez le numéro de titre (longueur de 1 à 8 caractères)"/>
		</s:FormItem>
		<s:FormItem width="312" label="Objet">
			<s:TextInput id="objet" width="165"
						 prompt="Saisissez l'objet (proscrire toutes données à caractère personnel)"
						 toolTip="Saisissez l'objet (longueur 100 caractères maximum)"/>
		</s:FormItem>
		<s:FormItem width="312" label="Montant">
			<s:TextInput id="montant" width="167"
						 prompt="Saisissez le montant (sans point ni virgule)"
						 toolTip="Saisissez le montant (longueur de 6 chiffres maximum, sans point ni virgule)"/>
		</s:FormItem>
		<!--<s:FormItem width="312" label="Mél">
			<s:TextInput id="email" width="167"
						 text = ""
						 toolTip="Saisissez votre mél"
						 prompt="Saisissez votre mél"/>
		</s:FormItem>-->

		<s:Button id="btnEnvoyer" label="Envoyer" click="btnEnvoyer_clickHandler(event)" />
		<s:Spacer height="20" />
		<s:Label text="Composant TIPI version 1.0.1" fontSize="6" />
	</s:Form>
</s:Application>
